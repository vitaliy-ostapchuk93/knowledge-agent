name: Dependency Updates

on:
  push:
    paths:
      - 'package.json'
      - 'bun.lock'
      - 'src/**'
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of update to perform'
        required: true
        default: 'minor'
        type: choice
        options:
          - 'patch'
          - 'minor'
          - 'major'

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # Check for Dependency Updates
  dependency-updates:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Bun Environment
        uses: ./.github/actions/setup-bun

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Check for outdated packages
        id: outdated
        run: |
          echo "Checking for outdated packages..."
          bun outdated > outdated-packages.txt 2>&1 || true

          if [ -s outdated-packages.txt ]; then
            echo "outdated=true" >> $GITHUB_OUTPUT
            echo "Found outdated packages:"
            cat outdated-packages.txt
          else
            echo "outdated=false" >> $GITHUB_OUTPUT
            echo "All packages are up to date"
          fi

      - name: Update dependencies
        if: steps.outdated.outputs.outdated == 'true'
        run: |
          echo "Updating dependencies..."
          # Update based on input type
          case "${{ github.event.inputs.update_type || 'minor' }}" in
            "patch")
              echo "Updating patch versions only..."
              bun update --latest --patch
              ;;
            "minor")
              echo "Updating minor versions..."
              bun update --latest --minor
              ;;
            "major")
              echo "Updating to latest versions (including major)..."
              bun update --latest
              ;;
          esac

      - name: Set git user
        if: steps.outdated.outputs.outdated == 'true'
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "github-actions[bot]"

      - name: Set git remote with token
        if: steps.outdated.outputs.outdated == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}

      - name: Run tests after updates
        if: steps.outdated.outputs.outdated == 'true'
        run: |
          echo "Running tests to validate updates..."
          bun test --timeout 30000

      - name: Check TypeScript compilation
        if: steps.outdated.outputs.outdated == 'true'
        run: bunx tsc --noEmit --skipLibCheck

      - name: Create Pull Request
        if: steps.outdated.outputs.outdated == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Creating dependency update branch..."
          BRANCH="dependency-updates/${{ github.run_id }}"

          # Check if there are any changes to commit
          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes detected, skipping PR creation"
            exit 0
          fi

          git checkout -b "$BRANCH"
          git add package.json bun.lock
          git commit -m "chore: update dependencies (${{ github.event.inputs.update_type || 'minor' }})"
          
          # Push with error handling
          if ! git push origin "$BRANCH" 2>&1; then
            echo "‚ùå Failed to push branch. This may be due to insufficient permissions."
            echo "Please ensure the GITHUB_TOKEN has write access to contents and pull requests."
            exit 1
          fi
          
          echo "Creating pull request with gh cli..."
          if ! gh pr create \
            --title "chore: Dependency Updates (${{ github.event.inputs.update_type || 'minor' }})" \
            --body "## Dependency Updates\n\nThis PR updates project dependencies to their latest ${{ github.event.inputs.update_type || 'minor' }} versions.\n\n### Changes\n- Updated dependencies using \`bun update --latest --${{ github.event.inputs.update_type || 'minor' }}\`\n- Verified all tests still pass\n- Confirmed TypeScript compilation succeeds\n\n### Validation\n- ‚úÖ All tests passing\n- ‚úÖ TypeScript compilation clean\n- ‚úÖ No breaking changes detected\n\n### Review Notes\nPlease review the \`package.json\` and \`bun.lock\` changes to ensure no unexpected major version bumps occurred.\n\nAuto-generated by dependency update workflow." \
            --head "$BRANCH" \
            --base "${{ github.ref_name }}" 2>&1; then
            echo "‚ùå Failed to create PR. This may be due to insufficient permissions."
            echo "Please ensure the GITHUB_TOKEN has write access to pull requests."
            exit 1
          fi

  # Security Audit
  security-audit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun Environment
        uses: ./.github/actions/setup-bun

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run security audit
        id: audit
        run: |
          echo "Running security audit..."
          bun audit --audit-level high > audit-results.txt 2>&1 || true

          if grep -q "vulnerabilities found" audit-results.txt; then
            echo "vulnerabilities=true" >> $GITHUB_OUTPUT
            echo "Security vulnerabilities found:"
            cat audit-results.txt
          else
            echo "vulnerabilities=false" >> $GITHUB_OUTPUT
            echo "No high-severity vulnerabilities found"
          fi

      - name: Create security issue
        if: steps.audit.outputs.vulnerabilities == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Creating security issue with gh cli..."
          AUDIT_RESULTS=$(cat audit-results.txt)
          if ! gh issue create \
            --title "üö® Security vulnerabilities detected in dependencies" \
            --body "## Security Audit Results\\n\\nHigh-severity vulnerabilities have been detected in project dependencies.\\n\\n### Audit Output\\n\\n\`\`\`\\n$AUDIT_RESULTS\\n\`\`\`\\n\\n### Recommended Actions\\n1. Review the vulnerabilities listed above\\n2. Update affected packages to secure versions\\n3. Run \`bun audit\` locally to verify fixes\\n4. Consider using \`bun audit --fix\` for automatic fixes\\n\\n### Auto-Generated\\nThis issue was automatically created by the dependency update workflow." 2>&1; then
            echo "‚ùå Failed to create security issue. This may be due to insufficient permissions."
            echo "Please check manually: bun audit --audit-level high"
            echo "Audit results:"
            cat audit-results.txt
            exit 1
          fi
